\chapter{Representative State Transfer (REST)}
\label{chap:rest}

%% (sekce \ref{subsec:features}) 

\section{REST architecture}
\label{sec:rest-architecture}

The REST is an architectural style. "a set of constraints on the overall arichitectural approach"(agile argitecture). The goal of REST is to create a distributed hypermedia application It is resource-based, which means that it handles with resources instead of making actions, resources are named by nouns, and the actions are provided by HTTP requests. Rest architecture is client-server.
RESTful web services have their best practices and constraints. There are 6 constraints characterizing the REST. 

REST architecture has its elements, which do not define the technologies of implementation but are abstraction of the components behaviour. Components have its roles, the way of interaction among them and interpretation.

The data elements are:

\begin{description}
  \item resource
  \item resource identifier
  \item representation
  \item representation metadata
  \item resource metadata
  \item control data
  %%http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm
\end{description}

The connectors are:

\begin{description}
  \item client
  \item server
  \item cache
  \item reolver
  \item tunnel 
\end{description}

REST components:

\begin{description}
  \item origin server
  \item gateway
  \item proxy
  \item user agent
\end{description}


\section{REST rapresentation}
Every resource has its representation, it describes how resources get manipulated in RESTful  API architecture. The representation represents part of (or less commonly the whole) resource state, it is transferred between the client and server and has generally the JSON or XML format, but could be in many more other formats as well. The representation is composed from resource and attached files which provide enough information for the client to be able to modify the resource on the server.

\section{REST constraints}

Six constraints that are applied to the architecture to create RESTful services. Respecting this rules leads to desiderable properties of the system, such as performance, scalability, simplicity, modifiability, visibility, portability and reliability. 
%%(citacia http://www.restapitutorial.com/lessons/whatisrest.html#)
\begin{description}
  \item The six constraints are:

\begin{enumerate}
  \item Uniform Interface
  
Define interface between client and server. It separates client and server allowing them to develop each part independently. The interface is uniform, so that is
easier to understand for both, the server and the client.
Interface is resource-based - requests in \emph {URI} (Uniform Resource Idetifier) contain the resource identifiers which identifies the concrete resource. To the client is then sent the representation which is conceptually separated from the resource. The representation is commonly in HTML, XML or JSON format and represents appropriate database record.
Resources are manipulated exclusively throught the rapresentations. The representation with any metadata attached, keeps enough information for the client and allow him to modify the resource on the server.
The sentmessage which represents the request sent by client or the response form the server is self-decriptive. That means there is enough information to know hov to process the message and the response explicitely defines the cashability.
The representation is sent using \emph {HTTP specification}, client call the resource using HTTP verbs (GET, POST, PUT, DELETE,..) and the URI, server sends to the client the HTTP response.


  \item Stateless

The messages in REST architecture are stateless, the state can be stored via \emph {HATEOAS} (Hypermedia as the Engine ot Application State). From client side, the state can be delivered through body content of the message (request), query parematers in the URI, headers in request. From server side the state can be delivered via body content of the message (response), response code and respone header. 
The necessary state is contained within the request, there are more options how to store it, whether it can be a part od the URI, query-string paremeter, header or body.The Uri identifies the concrete resource and the body includes the state. Then after process the message the state is send back to the client via headers, status and response body.
The statelessness allows greater scalability, because server doesn't have to cammunicate with the session, which creatiaon is necessary to carry the state using some other design of services.


Each message is self-descriptive, has enough context to be processable by the server. Messages has no state. If the state is needed, the representation is what is holding it.?????

\item Client-server

RESTful architecture is client-server architecture. There are two disconnected concerns, separation of this them is properly defined and it specifies what is user interface and services. Client can’t have direct access to the database, assets or resources, which improves the portability of client code. Servers are not included in uder interface, which improves the simplicity and scalability of server-side code. Uniform interface links the client and server together. The two concerns can be developed indipendently as long as the interface is not altered. 

\item Cashable

Server responses (representations) are cashable, everything that comes back to server or from REST service could be cashable. Responses are able to to define themselfs as cashable implicitly (it’s not noted in general client), explicitly (server specifies) or negotiated (to figure out how long can be cashed), to avoid the inappropriate reuse of data contained in response in further requests. Cashing partially limits the clinet-server interacton but improves the scalability and performance.

\item Layered system

Linked to cashability and client-server. Client is not able to see if he is communicating diractly with the server, or wit som intermedia between them. Intermedia improves scalability, provide shared cashes and morover can enforce the security policies.

\item Code on demand (optional)

The logic can be transferred to the client-side, this way the server can temporarily extends or customize the functionality of the client. This can be performed for example by the components like service-side scripts.
This constraint is unique, it is the only one which can be violated and the services can be still reffered as RESTfull.

\end{enumerate}
\end{description}
%%\footnote{Technologie jsou popsány v sekci~\ref{sec:technologies}.} 





\begin{lstlisting}[language=bash]
  $ curl -sS https://getcomposer.org/installer | php
\end{lstlisting}

Jakmile je composer dostupný, lze již Drush nainstalovat v jeho 6. verzi:

\begin{lstlisting}[language=bash]
  $ composer global require drush/drush:6.*
\end{lstlisting}

Po instalaci je vhodné nastavit prostředí systému a integraci mezi nástroji \emph{Drush} a \emph{BASH}. Do souboru \texttt{.bashrc} v domovském adresáři vložte řádek obsahující cestu k Drushi a kód s nahráním souboru .drush\_bashrc.

\begin{lstlisting}[language=bash]
export PATH="$HOME/.composer/vendor/bin:$PATH"

if [ -f ~/.drush_bashrc ] ; then
  . ~/.drush_bashrc
fi
\end{lstlisting} 

Je vhodné aktualizovat bashrc soubor:

\begin{lstlisting}[language=bash]
  $ source ~/.composer/vendor/drush/drush/examples/
    example.bashrc
\end{lstlisting} 

Nyní by měly být přístupné příkazy pod zkrácenými aliasy - například \texttt{dr} místo \texttt{drush} a \texttt{cc} namísto \texttt{drush cache-clear}. Je možné i povolit automatické doplňování příkazů, dle instrukcí na stránkách vývojového týmu. Dále je vhodné v souboru \linebreak\texttt{\$HOME/.drush/aliases.drushrc.php} definovat alias stránky pro usnadnění manipulace. Obsah souboru může vypadat následovně:

\begin{lstlisting}[language=php]
  <?php
  $aliases['pravo'] = array(
    'root' => '/srv/www/htdocs/',
    'uri' => 'pravo.com',
  );
\end{lstlisting}

Po tomto nastavení je možné do složky přistoupit jednoduše pomocí příkazu \texttt{\$~cddl~@pravo} (případně \texttt{\$~cd~@pravo} pokud je nastavený alias pro příkaz \texttt{cd}). Všechny příkazy nástroje \emph{Drush} je možné spouštět pro daný alias, což je výhodné v případě více prostředí (vývojové vs. produkční).

Obsah repozitáře projektu může být umístěn kdekoliv, například v domovské složce uživatele:

\begin{lstlisting}[language=bash]
  $ cd ~
  $ git clone git@github.com:kanei/esf-mu-portal.git  
\end{lstlisting}

Před samotnou instalací je nutné nastavit základní vlastnosti projektu. Soubor \texttt{phing/default.build.properties} překopírujte do hlavní složky repozitáře a přejmenujte jej na \texttt{build.properties}:

\begin{lstlisting}[language=bash]
  $ cp ~/esf-mu-portal/phing/default.build.properties 
    ~/esf-mu-portal/build.properties
\end{lstlisting}

Druhou možností je spuštění úvodní inicializace, jejíž součástí je i překopírování souboru v případě, že neexistuje:

\begin{lstlisting}[language=bash]
  $ phing void
\end{lstlisting}

V konfiguračním souboru je nutné v proměnné \texttt{project.dir} nastavit cílovou složku pro instalaci. Složka však nesmí existovat a uživatel spouštějící skript musí mít práva k jejímu vytvoření, protože jinak \emph{Drush} není schopen s instalací pokračovat a skončí s chybovou hláškou. V konfiguračním souboru lze změnit další nastavení, jakými jsou administrátorský účet, url databáze a pod, ale pro základní funkcionalitu je možné tyto hodnoty ponechat nezměněné.


\section{Nasazení (deployment) a jeho možnosti}



V konfiguračním souboru je vhodné zadat nastavení prostředí, na kterém se bude portál instalovat (cesty k souborům, nastavení databáze a pod.) - více informací je v samotném souboru.

\begin{description}
  \item[void] \hfill \\
  Pouze provede inicializaci konfiguračních souborů a ukončí se.  
  \item[guacamole] 
  Vytvoří konfigurační soubory projektu Guacamole ve správných složkách (je zkopírován soubor \texttt{phing/default.guacamole.properties}.
  \item[deploy]
  Překopíruje aktuální moduly na správné místo a zajistí správné nastavení portálu dle aktuálního nastavení (převážně využití Features).
  \item[install]
  Provede kompletní instalaci portálu dle nastavení v konfiguračních souborech - překopíruje moduly a témata specifická pro toto řešení, stáhne potřebné zdrojové kódy Drupalu z internetu a nainstaluje Drupal, kterému následně nastaví správné téma vzhledu a povolí potřebné moduly.
\end{description}

\section{Instalace informačního systému (Drupal)}
Instalace probíhá za využití dávkového instalačního souboru \texttt{build.xml}, ve kterém je krom jiného popsán instalační cíl \emph{install} (viz předchozí kapitola). Pro spuštění instalace je potřeba v terminálu spustit následující příkaz:

\begin{lstlisting}[language=bash]
  $ phing install
\end{lstlisting}

\subsection*{Průběh instalace}

\begin{enumerate}
  \item Je zkontrolována cílová složka a uživatel je případně upozorněn na nutnost jejího smazání.
 
  \item Do projektového adresáře jsou překopírovány moduly, témata a instalační profily projektu, aby s nimi mohl instalační skript pracovat.
  \item Při instalaci nejsou automaticky provedeny všechny úkony a některá nastavení je nutné spustit manuálně po dokončení. Jedná se mimo jiné o nastavení tématu vzhledu.
  \item \lstinline[language=bash]{$ drush site-install} - Spustí se instalace Drupalu z příkazové řádky, při které se povolí základní moduly a vytvoří databázová struktura. Je nainstalován instalační profil \emph{esf\_profile} a s ním jsou povoleny moduly rozšiřující funkcionalitu a také rysy dokončující nstavení stránek. Celý proces trvá až několik minut a v průběhu nijak uživatele neinformuje o průběhu, je tedy důležité vyčkat až do jeho ukončení.
\end{enumerate}

Po instalaci je vhodné zkontrolovat práva souborů a nastavit uživatele i skupinu na hodnoty daného internetového serveru (apache/lighttpd/\dots)

\begin{lstlisting}[language=bash]
  $ sudo chown apache esf -R 
  $ sudo chgrp apache esf -R
\end{lstlisting}

Toto je obzvláště důležité v případě použití \emph{SQLite} databáze, ke které jinak nemá drupal práva zapisovat a tím pádem stránky spadnou s fatální chybou. 

Pokud vše proběhlo v pořádku a server je schopen přistupovat ke všem souborům i databázi, je možné na adrese propojené se stránkami navštívit úvodní stránku (např. \emph{http:/localhost/esf}). Na stránky bylo převedeno veškeré nastavení, ale nebyl zde vytvořen žádný obsah. Ten lze buď migrovat z produkčních stránek, nebo generovat za pomocí modulu \emph{Devel}. Na adrese \emph{http://localhost/esf/?q=user} se lze přihlásit za pomocí administrátorského účtu (pokud nebyl změněn v konfiguračním souboru, jedná se o účet admin a heslo admin) a přistoupit k administračnímu rozhraní stránek.

\section{Instalace Guacamole}
Guacamole vyžaduje na straně serveru dvě komponenty: \emph{JAVA} \gls{servlet} aplikaci a démona \emph{Guacd}. Druhý jmenovaný není nijak upraven a lze tedy stáhnout aktuální verzi ze stránek projektu\footnote{V době sepsání tohoto textu byla aktuální verze 0.9, na které byl i celý projekt testován. Projekt je dostupný na adrese http://guac-dev.org/release/release-notes-0-9-0}. Po stažení stačí zkompilovat a nainstalovat projekt (za předpokladu, že jsou v systémy dostupný všechny knihovny a nástroje zmíněné v kapitole~\ref{sec:priprava-systemu}):

\begin{lstlisting}[language=bash]
  $ cd guacamole-server-0.9.0
  $ ./configure
  $ make
  $ make install
  $ ldconfig
\end{lstlisting}

V této chvíli by již měl jít spustit příkaz \texttt{guacd}, který spustí na portu 4822 službu pro připojení ke vzdálené ploše. Nyní je potřeba nastavit parametry připojení. Na stránce portálu, na adrese \texttt{admin/config/esf/settings} je nutno nastavit správné hodnoty a zajistit přístup ke konfiguračnímu souboru Guacamole pro \emph{Drupal} i \emph{Guacamole} \emph{JAVA} aplikaci. Dále budou předpokládány výchozí hodnoty nastavení.

\begin{lstlisting}[language=bash]
  $ cp ~/esf-mu-portal/phing/default.guacamole.properties /srv/guacamole/guacamole.properties
  $ chown apache guacamole.properties 
  $ chgrp apache guacamole.properties 
\end{lstlisting}

Jméno a uživatelská skupina závisí na použitém operačním systému. V souboru guacamole.properties je nutno nastavit parametry připojení ke vzdálené ploše \gls{aspi} a informace o démonu Guacd, což lze udělat buď přímo v souboru, nebo za pomocí Drupalu na adrese \texttt{admin/config/esf/remote}. 

Tím je dokončeno nastavení démona a lze přikročit k instalaci \emph{JAVA} \gls{servlet}. Ten je potřeba zkompilovat a nahrát jako do \emph{Apache Tomcat}.

\begin{lstlisting}[language=bash]
  $ cd ~/esf-mu-portal/
  $ mvn package
  $ cp ~/esf-mu-portal/target/guacamole-esf-0.4.war /srv/tomcat/webapps/
  $ rctomcat restart

\end{lstlisting}

Po dokončení kompilace by měla být aplikace automaticky dostupná na adrese \texttt{localhost:8080/guacamole-esf-[číslo verze]/}. Tuto adresu je nutné zadat do políčka \emph{Guacamole Servlet path} v portálu na adrese \\ \texttt{admin/config/esf/settings}. Poté by se již uživatelé měli být schopni přihlásit ke vzdálené ploše na adrese \texttt{/aspi}.

\section{Administrace}
\label{sec:administrace}
Správa probíhá za využití administrace dodávané v jádře \emph{Drupalu}, rozšířené modulem \emph{Workbench} a dalšími úpravami. Pro správu portálu jsou definovány čtyři úrovně uživatelských práv:

\begin{itemize}
  \item \textbf{anonymní uživatel} \hfill \\
    Tato role je spolu s rolí \emph{přihlášeného uživatele} definována v jádře \gls{cms} a nelze ji tedy měnit. Označuje uživatele, kteří se nepřihlásili do portálu. S ohledem na nutnost autentikace jsou tito uživatelé odstřiženi od přístupu k jakýmkoliv datům a je jim zpřístupněna pouze stránka s přihlášením.
  \item \textbf{přihlášený uživatel} \hfill \\
    Po přihlášení uživatelé získávají přístup k veškerému hlavnímu obsahu stránek, uživatelskému nastavení a připojení ke vzdálené ploše. 
  \item \textbf{moderátor} \hfill \\
    Moderátor má přístup k základní administraci stránek, obzvláště k úpravám obsahu, základním změnám provázání obsahu a administraci přístupu uživatelů.
  \item \textbf{administrátor} \hfill \\
    Pro tohoto uživatele neexistuje speciální role, ale jedná se o uživatele s identifikačním číslem 1, který má právo přístupu ke všem prvkům obsahu a administrace portálu a tato práva nejdou nijak omezit.
\end{itemize}

Tato práce se zabývá pouze specifickou administrací a nezaobírá se administrací Drupalu, ve které nebyly provedeny změny výraznějšího charakteru a funguje dle standartního přístupu. Po přihlášení má uživatel s rolí moderátora dostupný administrační panel umistitelný buď v horní, nebo levé části okna prohlížeče (obrázek~\ref{fig:workbench}). Administrační panel obsahuje odkazy na administrační stránky a pracovní stůl. 

\subsection*{Struktura pracovního stolu}
\begin{description}
  \item[Můj obsah] \hfill \\
  Tato sekce nabízí pohled na stránky vytvořené či upravené právě přihlášeným uživatelem a na nejaktuálnější obsah portálu všeobecně. Všechny pohledy vedou po rozkliknutí na detailnější přehledy obsahu dané sekce.  
  \item [Vytvořit obsah] \hfill \\
  V této sekci je možné vytvářet veškerý obsah, ke kterému má uživatel přístup - buď mediální obsah (obrázky, videa, dokumenty), ke kterému lze později přistupovat skrze \gls{wysiwyg} editor, nebo vlastní obsah portálu - nové předměty, stránky, obory práva viz. sekce~\ref{subsec:typy-obsahu}.
  \item [Seznam souborů] \hfill \\
  Poskytuje náhled na všechny soubory nahrané na portál, které jsou sledovány systémem a dostupné skrze administrační rozhraní.
  \item [Obory práva] \hfill \\
  Pohled na všechny zadané obory práva, jejich základní atributy a předměty, které se k nim vztahují. S obory práva lze manipulovat pomocí rozhraní využívajícího modulu \emph{Views Bulk Operations} (sekce~\ref{subsec:vbo}) a tím pádem hromadnou úpravu entit.
  \item [Předměty] \hfill \\
  Poskytuje, podobně jako sekce předchozí, pohled na předměty, pouze s tím rozdílem, že neukazuje jejich propojení na obory práva, ale materiály, které jsou k nim přidružené.
\end{description}

Veškerý obsah stránek je pokryt verzováním a je možné ukládat tzv. revize obsahu, mezi kterými lze zobrazit výčet změn od předchozí verze. K editaci slouží \gls{wysiwyg} editor \emph{CKeditor}, poskytující uživatelům přívětivé rozhraní s rozšířenými možnostmi úpravy textu a prvky specificky vytvořenými pro použití s \gls{cms} Drupal. Pro prohlížení souborů uložených na serveru ve specifické složce se využívá modulu \emph{IMCE}.

\begin{figure}[htp]
%%  \includegraphics
  \caption{Prostředí pracovního stolu pro uživatele s právy moderátora.}
  \label{fig:workbench}
\end{figure}  

\section{Výkonové optimalizace}
\emph{Drupal} je všeobecně znám pro svou vysokou náročnost na výpočetní výkon serveru, což je způsobeno jeho rozšiřitelností. Z tohoto důvodu je nutné používat pokročilé techniky ukládání a načítání z vyrovnávací paměti\cite{high-performance-drupal}. Od verze 7 je v jádru implementováno hned několik přístupů ke zvýšení výkonu:

\begin{description}
  \item[Registry] \hfill \\
  Protože mnoho částí systému umožňuje přepisování výstupu za pomocí jmenných konvencí, jsou soubory prohledávány pouze jednou a informace o dostupných funkcích jsou uloženy v databázi. Kvůli tomuto přístupu je nutné přebudovat registry pokaždé, když je přidán nový soubor, například typu \texttt{.tpl.php}. K této operaci slouží modul \emph{Registry Rebuild}\footnote{https://drupal.org/project/registry\_rebuild}. Inicializace registrů nejde vypnout a pouze v nastavení některých témat vzhledu a za pomoci modulu \emph{Devel} lze nastavit, aby se přebudovávaly při každém načtení stránky. S tím však značně klesá výkon.
  \item[Vyrovnávací paměť] \hfill \\
  Za pomocí Cache \gls{api} je možné využívat vyrovnávací paměti typicky uložené v databázi. V jádru je definováno několik tabulek pro ukládání a moduly mohou jednoduše definovat další (například modul \emph{Views} a tabulka \emph{cache\_views}). Data z této vyrovnávací paměti jsou načítáná pouze v případě, kdy je povolena nastavení výkonu systému. V konfiguračním souboru je možné definovat umístění jednotlivých vyrovnávacích pamětí - další umístění mohou být přidávána rozšiřujícími moduly (například Memcache, APC, \dots).
  \item[Agregace] \hfill \\
  Při načítání obsahu stránek je pro každý soubor vytvořen nový požadavek, který je zaslán serveru. Pro snížení náročnosti komunikace je vhodné snížit počet souborů, čehož je typicky dosáhnuto agregací JavaScriptových a \gls{css} souborů (v případě, že je obsah poskytován z více domén, je vhodné ponechat alespoň několik výsledných souborů, které mohou být stahovány paralelně)\cite{website:drupal:optimizing}. Základní funkcionalita je rozšířena modulem \emph{Advanced Aggregation}\footnote{https://drupal.org/project/advagg}.
  \item[Statická vyrovnávací paměť] \hfill \\
 řeší modul \emph{Authenticated Cache}\footnote{https://drupal.org/project/authcache}, 
\end{description}
